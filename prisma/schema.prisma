generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER
// ============================================
model User {
  id                String    @id
  email             String    @unique
  name              String
  username          String?   @unique
  avatarUrl         String?   @map("avatar_url")
  phone             String?
  bio               String?
  vacationMode      Boolean   @default(false) @map("vacation_mode")
  blockedDates      String    @default("[]") @map("blocked_dates") // JSON array of dates
  stripeCustomerId  String?   @map("stripe_customer_id")
  stripeConnectId   String?   @map("stripe_connect_id")

  // Verification fields
  idVerified        Boolean   @default(false) @map("id_verified")
  addressVerified   Boolean   @default(false) @map("address_verified")
  phoneVerified     Boolean   @default(false) @map("phone_verified")
  verificationDocs  String    @default("[]") @map("verification_docs") // JSON array of doc URLs
  verifiedAt        DateTime? @map("verified_at")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  products          Product[]
  locations         Location[]
  bookingsAsHirer   Booking[]  @relation("HirerBookings")
  bookingsAsLister  Booking[]  @relation("ListerBookings")
  sentMessages      Message[]
  reviewsGiven      Review[]   @relation("ReviewerReviews")
  reviewsReceived   Review[]   @relation("RevieweeReviews")
  transactions      Transaction[]
  favorites         Favorite[]
  reports           Report[]   @relation("ReporterReports")
  reportsReceived   Report[]   @relation("ReportedUserReports")

  @@map("users")
}

// ============================================
// PRODUCT (Listing)
// ============================================
model Product {
  id          String   @id @default(uuid())
  ownerId     String   @map("owner_id")
  title       String
  description String
  category    String   // Event furniture, Lighting, etc.
  tags        String   @default("[]") // JSON array
  condition   String   // Like New, Good, Fair, Poor, Vintage/Antique
  color       String
  quantity    Int      @default(1)
  price1Day   Float    @map("price_1_day")
  price3Day   Float?   @map("price_3_day")
  price7Day   Float?   @map("price_7_day")
  images      String   @default("[]") // JSON array of image URLs
  locationId  String?  @map("location_id")
  status      String   @default("ACTIVE") // ACTIVE, PAUSED, DELETED
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner       User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  location    Location? @relation(fields: [locationId], references: [id])
  bookings    Booking[]
  reviews     Review[]
  favorites   Favorite[]
  reports     Report[]

  @@index([ownerId])
  @@index([category])
  @@index([status])
  @@map("products")
}

// ============================================
// LOCATION (Collection Point)
// ============================================
model Location {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  address   String
  postcode  String
  city      String
  type      String   @default("OTHER") // HOME, WORK, OTHER
  lat       Float?
  lng       Float?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products  Product[]

  @@index([userId])
  @@map("locations")
}

// ============================================
// BOOKING
// ============================================
model Booking {
  id              String   @id @default(uuid())
  productId       String   @map("product_id")
  hirerId         String   @map("hirer_id")
  listerId        String   @map("lister_id")
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  totalHirerCost  Float    @map("total_hirer_cost")
  listerPayout    Float    @map("lister_payout")
  platformFee     Float    @map("platform_fee")
  status          String   @default("PENDING") // PENDING, APPROVED, DECLINED, PAID, COLLECTED, RETURNED, COMPLETED, CANCELLED
  paymentIntentId String?  @map("payment_intent_id")
  cancelReason    String?  @map("cancel_reason")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  product         Product       @relation(fields: [productId], references: [id])
  hirer           User          @relation("HirerBookings", fields: [hirerId], references: [id])
  lister          User          @relation("ListerBookings", fields: [listerId], references: [id])
  messages        Message[]
  review          Review?
  transactions    Transaction[]

  @@index([productId])
  @@index([hirerId])
  @@index([listerId])
  @@index([status])
  @@map("bookings")
}

// ============================================
// MESSAGE
// ============================================
model Message {
  id        String   @id @default(uuid())
  bookingId String   @map("booking_id")
  senderId  String   @map("sender_id")
  text      String
  type      String   @default("USER") // USER, SYSTEM
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id])

  @@index([bookingId])
  @@map("messages")
}

// ============================================
// REVIEW
// ============================================
model Review {
  id          String   @id @default(uuid())
  bookingId   String   @unique @map("booking_id")
  productId   String   @map("product_id")
  reviewerId  String   @map("reviewer_id")
  revieweeId  String   @map("reviewee_id")
  rating      Int
  comment     String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  booking     Booking  @relation(fields: [bookingId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])
  reviewer    User     @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  reviewee    User     @relation("RevieweeReviews", fields: [revieweeId], references: [id])

  @@index([productId])
  @@index([revieweeId])
  @@map("reviews")
}

// ============================================
// TRANSACTION (Wallet)
// ============================================
model Transaction {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  bookingId         String?  @map("booking_id")
  amount            Float
  type              String   // PAYOUT, ESCROW, ESCROW_RELEASE, FEE, REFUND
  status            String   @default("PENDING") // PENDING, COMPLETED, FAILED
  stripeTransferId  String?  @map("stripe_transfer_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user              User     @relation(fields: [userId], references: [id])
  booking           Booking? @relation(fields: [bookingId], references: [id])

  @@index([userId])
  @@map("transactions")
}

// ============================================
// FAVORITE
// ============================================
model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("favorites")
}

// ============================================
// CONTACT INQUIRY
// ============================================
model ContactInquiry {
  id        String   @id @default(uuid())
  name      String
  email     String
  subject   String
  message   String
  status    String   @default("NEW") // NEW, IN_PROGRESS, RESOLVED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("contact_inquiries")
}

// ============================================
// REPORT
// ============================================
model Report {
  id              String   @id @default(uuid())
  reporterId      String   @map("reporter_id")
  type            String   // USER, PRODUCT
  targetUserId    String?  @map("target_user_id")
  targetProductId String?  @map("target_product_id")
  reason          String
  details         String?
  status          String   @default("PENDING") // PENDING, REVIEWED, RESOLVED, DISMISSED
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  reporter       User     @relation("ReporterReports", fields: [reporterId], references: [id])
  targetUser     User?    @relation("ReportedUserReports", fields: [targetUserId], references: [id])
  targetProduct  Product? @relation(fields: [targetProductId], references: [id])

  @@index([status])
  @@map("reports")
}
